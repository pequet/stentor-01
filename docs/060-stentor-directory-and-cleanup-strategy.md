# 060: Stentor: Directory Structure, File Lifecycle, and Cleanup Strategy

**Last Updated:** 2025-06-01 16:03:37

This document outlines the key directory structures used by the Stentor project on both the client (local machine) and the server (droplet), explains the lifecycle of data files, and provides strategies for cleanup and monitoring to ensure efficient disk space management.

## 1. Droplet Directory Structure

The Stentor droplet hosts the core processing components. Key directories include:

*   **`~/Stentor-01/`**
    *   **Purpose:** Contains the cloned Git repository of the Stentor project.
    *   **Contents:** All project scripts, documentation, and configuration templates.
    *   **Management:** Updated via `git pull` by the user.

*   **`~/src/whisper.cpp/`**
    *   **Purpose:** Houses the Whisper.cpp ASR engine.
    *   **Contents:** Compiled Whisper.cpp binaries, model files (e.g., `ggml-tiny.en.bin`).
    *   **Management:** Models downloaded by user; compiled by user. Relatively static.

*   **`~/stentor_harvesting/`** (This is the primary data processing area, typically mounted via SSHFS to `$HOME/.stentor_droplet_mount` on the client machine)
    *   **Purpose:** Central hub for all harvested and processed audio data.
    *   **Subdirectories:**
        *   **`inbox/`**
            *   **Contents:** Landing zone for newly downloaded audio files (MP3s, M4As) and their associated metadata (`.info.json`, `.description`, subtitles) generated by `download_to_stentor.sh`. Also contains `download_archive.txt` used by `yt-dlp` to prevent re-downloads.
            *   **Lifecycle:** Audio/metadata files are temporary here. They are moved to `processing/` by `queue_processor.sh`.
            *   **Cleanup:** Original audio/metadata files can be deleted from here after successful transcription and if the corresponding run directory in `~/stentor_processing_runs/` is also cleaned up (or after `queue_processor.sh --aggressive-cleanup`).
            *   **CRITICAL TO PRESERVE:** `download_archive.txt`. Deleting this will cause `yt-dlp` to re-download all previously fetched items from `content_sources.txt`.
        *   **`processing/`**
            *   **Contents:** Audio files currently being processed by `queue_processor.sh` and `process_audio.sh`.
            *   **Lifecycle:** Files are moved here from `inbox/` before `process_audio.sh` is invoked. Highly temporary.
            *   **Cleanup:** Should ideally be empty most of the time. Files stuck here indicate an operational issue.
        *   **`completed/`**
            *   **Contents:** Final transcription outputs (e.g., `.txt`, `.vtt`, `.srt` files) and the `processing_info.md` for each successfully processed audio file. This is the primary valuable output of the system.
            *   **Lifecycle:** Files here are considered final output.
            *   **Cleanup:** Retain as per user's data retention policy.
        *   **`failed/`**
            *   **Contents:** Audio files (and potentially their partial run directories, if configured) that failed processing after retries or due to critical errors.
            *   **Lifecycle:** Files are moved here by `queue_processor.sh`.
            *   **Cleanup:** Review periodically. Delete or archive based on user policy.
        *   **`logs/`** (Optional - may not be used if logs are elsewhere)
            *   **Contents:** Aggregated logs from `queue_processor.sh` or other server-side processes.
            *   **Cleanup:** Rotate or archive as needed.

*   **`~/stentor_processing_runs/`**
    *   **Purpose:** Contains individual, timestamped run directories for each invocation of `process_audio.sh`. Each run directory is typically named `[file_hash]_[timestamp]`.
    *   **Contents (per run directory):**
        *   Temporary audio files created during processing (`audio_workable.wav`, `segments/*.wav`).
        *   Log files specific to that run (`processing_info.md`, `whisper_output.log`, `segmentation.log`, etc.).
        *   Copies of the final transcript files.
    *   **Lifecycle & Cleanup:**
        *   **Default Behavior:** When `process_audio.sh` is called by `queue_processor.sh` (which uses the `--cleanup-temp-audio` flag for `process_audio.sh`), the bulky temporary WAV files (`audio_workable.wav`, `segments/*.wav`) within the run directory are deleted upon successful completion of `process_audio.sh`. The run directory itself, now containing only logs and transcripts, persists.
        *   **With `queue_processor.sh --aggressive-cleanup`:** If `queue_processor.sh` is run with its `--aggressive-cleanup` flag, after it successfully processes a file and copies the final transcript to `~/stentor_harvesting/completed/`, it will then delete the *entire* corresponding run directory from `~/stentor_processing_runs/`. This is the most disk-space-efficient mode.
        *   **Monitoring:** If not using `--aggressive-cleanup`, monitor the number of accumulating run directories. Their individual size should be relatively small (text files only).

## 2. Client-Side Directory Structure (Local Machine)

*   **`~/.stentor/`**
    *   **Purpose:** Stores local configuration, logs, and lock files for client-side Stentor scripts.
    *   **Contents:**
        *   `content_sources.txt`: User-managed list of YouTube/podcast URLs for `periodic_harvester.sh`.
        *   `logs/`: Logs generated by client-side scripts (e.g., `periodic_harvester.log`).
        *   `.env` (Optional): Client-specific environment variables (e.g., SSH details for mounting). Overridden by a project-local `.env`.
        *   `download_to_stentor.lock`: Lock file to ensure only one instance of `download_to_stentor.sh` runs.
        *   `README.md`: Explains the purpose and contents of this directory.

*   **`$PATH_TO_PROJECT_REPO/Stentor-01/`** (e.g., `/Users/Shared/Git/repositories/Stentor-01/`)
    *   **Purpose:** Local clone of the Stentor Git repository.
    *   **Contents:** All project scripts, documentation, etc.
    *   `.env` (Optional): Project-specific environment variables, takes precedence over `~/.stentor/.env`.

*   **`$LOCAL_MOUNT_POINT`** (e.g., `$HOME/.stentor_droplet_mount`)
    *   **Purpose:** The local directory where the droplet's `~/stentor_harvesting/` directory is mounted using SSHFS.
    *   **Contents:** Mirrors the content of `~/stentor_harvesting/` on the droplet when mounted.

## 3. File Lifecycle & Cleanup Strategy Summary

1.  **Harvesting:** `periodic_harvester.sh` reads `~/.stentor/content_sources.txt`. For each URL, `download_to_stentor.sh` is called.
2.  **Downloading:** `download_to_stentor.sh` downloads audio/metadata to `MOUNT_POINT/inbox/` (e.g., `~/.stentor_droplet_mount/inbox/`). It uses `MOUNT_POINT/inbox/download_archive.txt` to avoid re-downloads.
3.  **Queueing:** `queue_processor.sh` (on droplet) monitors `~/stentor_harvesting/inbox/`.
4.  **Processing Staging:** `queue_processor.sh` moves a file from `inbox/` to `~/stentor_harvesting/processing/`.
5.  **Transcription Run:** `process_audio.sh` is invoked.
    *   Creates a unique run directory in `~/stentor_processing_runs/NAME_TIMESTAMP/`.
    *   Converts audio to WAV, segments it (temporary WAVs stored in its run directory).
    *   Transcribes segments, creating text files (transcripts also stored in its run directory).
    *   **Default Cleanup (by `process_audio.sh`):** Deletes its temporary WAV files from its run directory. Logs and transcripts remain in the run directory.
6.  **Completion:** `queue_processor.sh` copies the final transcript(s) from the `process_audio.sh` run directory to `~/stentor_harvesting/completed/`.
7.  **Aggressive Cleanup (Optional, by `queue_processor.sh`):** If `queue_processor.sh` used `--aggressive-cleanup`, it deletes the entire `~/stentor_processing_runs/NAME_TIMESTAMP/` directory.
8.  **Further Manual/Policy-Based Cleanup:**
    *   Original downloaded audio files (e.g., MP3s) in `~/stentor_harvesting/inbox/` can be deleted once successfully transcribed and if no longer needed for archival. **`download_archive.txt` in this directory MUST be preserved.**
    *   Files in `~/stentor_harvesting/failed/` should be reviewed and deleted/archived periodically.
    *   If not using aggressive cleanup, the run directories in `~/stentor_processing_runs/` (containing logs/transcripts) might accumulate. Decide on a retention policy for these logs.

## 4. Wiping for Clean Tests

To reset the droplet for a clean test run, while preserving the crucial download archive:

1.  **Backup `download_archive.txt` (Optional but Recommended):**

```bash
# On the droplet
cp ~/stentor_harvesting/inbox/download_archive.txt ~/download_archive.txt.backup
```

    Or, if cleaning from the client via the mount point:

```bash
# On the client
cp ~/.stentor_droplet_mount/inbox/download_archive.txt ~/download_archive.txt.backup
```

2.  **Delete Content:**
    *   **On the Droplet:**

```bash
# Careful with rm -rf!
rm -rf ~/stentor_harvesting/completed/*
rm -rf ~/stentor_harvesting/failed/*
rm -rf ~/stentor_harvesting/processing/*
# To clear inbox EXCEPT archive:
find ~/stentor_harvesting/inbox/ -mindepth 1 -maxdepth 1 ! -name 'download_archive.txt' -exec rm -rf {} \;

rm -rf ~/stentor_processing_runs/*
```

    *   **Alternatively, from Client (if mounted):**

```bash
# Careful with rm -rf!
MOUNT_POINT="$HOME/.stentor_droplet_mount" # Or your actual mount point
rm -rf "$MOUNT_POINT/completed/"*
rm -rf "$MOUNT_POINT/failed/"*
rm -rf "$MOUNT_POINT/processing/"*
# To clear inbox EXCEPT archive:
find "$MOUNT_POINT/inbox/" -mindepth 1 -maxdepth 1 ! -name 'download_archive.txt' -exec rm -rf {} \;

# Note: ~/stentor_processing_runs/ must be cleaned directly on the droplet as it's not part of the mount.
# You would ssh into the droplet and run: rm -rf ~/stentor_processing_runs/*
```

3.  **Restore `download_archive.txt` if accidentally deleted or if you cleared the whole inbox:**

```bash
# On the droplet
mv ~/download_archive.txt.backup ~/stentor_harvesting/inbox/download_archive.txt
```

## 5. Monitoring Considerations

*   **Disk Space (`df -h`):** Useful for overall droplet disk usage.
*   **Folder Sizes (`du -sh /path/to/folder`):**
    *   Monitor `du -sh ~/stentor_harvesting/` periodically.
    *   Monitor `du -sh ~/stentor_processing_runs/` periodically.
    *   Monitor `du -sh ~/src/whisper.cpp/models/` (static, but good to know).
*   **Number of Files/Directories:**
    *   `ls -l ~/stentor_processing_runs/ | wc -l` (to see number of old run directories if not using aggressive cleanup).
    *   `ls -l ~/stentor_harvesting/inbox/ | wc -l` (number of items waiting).
*   **Log Files:** Periodically check script logs for errors, especially:
    *   `~/stentor_harvesting/logs/` (if used)
    *   Logs within individual `~/stentor_processing_runs/[run_id]/` directories.
    *   Client-side logs in `~/.stentor/logs/`.

A future enhancement could be a small script that runs `du -sh` on these key directories and provides a summary "dashboard" output.

### Example Monitoring Dashboard Script

Below is a basic example of a script that could be run on the droplet to provide a quick status overview. This can be expanded and refined over time.

```bash
#!/bin/bash

echo "--- Stentor System Dashboard ---"
echo "Date: $(date)"
echo ""
echo "Overall Disk Usage:"
df -h / # Or the relevant partition for your data, e.g., /mnt/volume_xyz if using a separate volume
echo ""
echo "Key Stentor Folder Sizes:"
du -sh ~/stentor_harvesting 2>/dev/null || echo "Info: ~/stentor_harvesting not found or access issue."
du -sh ~/stentor_processing_runs 2>/dev/null || echo "Info: ~/stentor_processing_runs not found or access issue."
du -sh ~/stentor_harvesting/inbox 2>/dev/null || echo "Info: ~/stentor_harvesting/inbox not found or access issue."
du -sh ~/stentor_harvesting/completed 2>/dev/null || echo "Info: ~/stentor_harvesting/completed not found or access issue."
du -sh ~/stentor_harvesting/failed 2>/dev/null || echo "Info: ~/stentor_harvesting/failed not found or access issue."
du -sh ~/src/whisper.cpp/models 2>/dev/null || echo "Info: ~/src/whisper.cpp/models not found or access issue."
echo ""
echo "Queue Status:"
items_in_inbox=$(ls -1A ~/stentor_harvesting/inbox 2>/dev/null | grep -v 'download_archive.txt' | wc -l)
active_runs=$(ls -1A ~/stentor_processing_runs 2>/dev/null | wc -l)

echo "Items in harvesting inbox (excluding archive): ${items_in_inbox:-0}"
echo "Active processing runs (approx): ${active_runs:-0}"
echo "--- End Dashboard ---"
```

This document will evolve as the Stentor system matures. 